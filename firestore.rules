/**
 * This ruleset enforces a security model for an e-prescription system. It's
 * based on user ownership, shared access for collaborative documents, and a
 * distinct 'admin' role with elevated privileges, now managed in a separate
 * 'admins' collection.
 *
 * Core Philosophy:
 * The security model is strict and explicit. Access is granted on a
 * need-to-know basis. A user can only access data directly related to them.
 * Admins are granted broader read and write access for site management, and
 * their roles are now checked against the `/admins/{userId}` collection.
 *
 * Data Structure:
 * The data is organized into flat, top-level collections. Doctor roles are on
 * '/doctors/{userId}' and admin roles are on '/admins/{userId}'. This
 * separation ensures that administrative users are distinct from application
 * (doctor) users.
 *
 * Key Security Decisions:
 * 1. Admin Role Separation: An 'admin' role is now checked via the `isAdmin()`
 *    function, which reads from the `/admins` collection. This separates
 *    content/system administrators from doctors.
 * 2. Patient Data: Strict user-ownership model. Only the patient or an admin
 *    can read/write.
 * 3. Prescriptions: A "Shared Access" model. Access is granted if the user is a
 *    participant (patient, doctor, pharmacy) or an admin. Writes are
 *    restricted to the doctor.
 * 4. Marketing/Public Content: Collections like `blogPosts`, `pricingPlans`,
 *    etc., are publicly readable but writable only by admins.
 * 5. Denormalization for Authorization: Prescriptions contain denormalized UIDs
 *    to avoid slow and costly `get()` calls in rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    // ===================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the user has the 'system_admin' role. Highest privilege.
     */
    function isSystemAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/systemAdmins/$(request.auth.uid)).data.role == 'system_admin';
    }

    /**
     * Checks if the user has the 'admin' role for site content management.
     */
    function isAdmin() {
      return isSignedIn() && (get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin' || isSystemAdmin());
    }

    /**
     * Checks if the user is the doctor who created the prescription.
     */
    function isDoctor(doctorId) {
      return isSignedIn() && request.auth.uid == doctorId;
    }
    
    /**
     * Checks if the user is a head doctor of a specific hospital.
     */
    function isHeadDoctor(hospitalId) {
        let doctorProfile = get(/databases/$(database)/documents/doctors/$(request.auth.uid)).data;
        return isSignedIn() && doctorProfile.role == 'head_doctor' && doctorProfile.hospitalId == hospitalId;
    }
    
    /**
     * Checks if the user is a head pharmacist of a specific pharmacy.
     */
    function isHeadPharmacist(pharmacyId) {
        let pharmacistProfile = get(/databases/$(database)/documents/pharmacists/$(request.auth.uid)).data;
        return isSignedIn() && pharmacistProfile.role == 'head_pharmacist' && pharmacistProfile.pharmacyId == pharmacyId;
    }

    /**
     * Checks if a user is an employee of a given pharmacy.
     */
    function isPharmacyEmployee(pharmacyId) {
        let pharmacistProfile = get(/databases/$(database)/documents/pharmacists/$(request.auth.uid)).data;
        return isSignedIn() && pharmacistProfile.pharmacyId == pharmacyId;
    }

    /**
     * Checks if the user is a participant in a given prescription.
     */
    function isParticipant(prescription) {
      let participantIds = [prescription.patientId, prescription.doctorId, prescription.pharmacyId];
      return isSignedIn() && request.auth.uid in participantIds;
    }
    
    // Collection Rules
    // =================

    /**
     * @description Manages patient user profiles. Only the patient can manage their own profile.
     * @path /patients/{patientId}
     */
    match /patients/{patientId} {
      allow read, write: if isOwner(patientId);
    }
    
    /**
     * @description Manages doctor user profiles. Can be read by any authenticated user.
     * Writable by the owner or a system admin.
     * @path /doctors/{doctorId}
     */
    match /doctors/{doctorId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow write: if isOwner(doctorId) || isSystemAdmin();
    }
    
    /**
     * @description Manages pharmacist user profiles. Read by authenticated users.
     * Writable by the owner, head pharmacist of the same pharmacy, or a system admin.
     * @path /pharmacists/{pharmacistId}
     */
    match /pharmacists/{pharmacistId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn(); // Allow listing for selection purposes
      allow write: if isOwner(pharmacistId) || isHeadPharmacist(resource.data.pharmacyId) || isSystemAdmin();
    }

    /**
     * @description Site admins for content management. Managed only by system admins.
     * @path /admins/{adminId}
     */
    match /admins/{adminId} {
      allow get, list, write: if isSystemAdmin();
    }
    
    /**
     * @description System admins with highest privileges. Managed only by other system admins.
     * @path /systemAdmins/{adminId}
     */
    match /systemAdmins/{adminId} {
        allow get, list, write: if isSystemAdmin();
    }

    /**
     * @description Stores hospital information. Read by authenticated users, writable by system admins.
     * @path /hospitals/{hospitalId}
     */
    match /hospitals/{hospitalId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSystemAdmin();
    }

    /**
     * @description Stores pharmacy information. Read by authenticated users.
     * Writable by head pharmacists of that pharmacy or system admins.
     * @path /pharmacies/{pharmacyId}
     */
    match /pharmacies/{pharmacyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isHeadPharmacist(pharmacyId) || isSystemAdmin();

      /**
       * @description Manages a pharmacy's inventory. Readable by any employee of the pharmacy.
       * Writable only by the head pharmacist or system admins.
       * @path /pharmacies/{pharmacyId}/inventory/{inventoryId}
       */
      match /inventory/{inventoryId} {
        allow get, list: if isPharmacyEmployee(pharmacyId) || isSystemAdmin();
        allow write: if isHeadPharmacist(pharmacyId) || isSystemAdmin();
      }
    }

    /**
     * @description Stores medication details. Publicly readable. Writable by admins.
     * @path /medications/{medicationId}
     */
    match /medications/{medicationId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin() || isSystemAdmin();
    }

    /**
     * @description Manages prescriptions. Readable by participants or relevant head staff.
     * Writable only by the prescribing doctor.
     * @path /prescriptions/{prescriptionId}
     */
    match /prescriptions/{prescriptionId} {
      allow get: if isParticipant(resource.data) || isHeadDoctor(get(/databases/$(database)/documents/doctors/$(resource.data.doctorId)).data.hospitalId) || isAdmin();
      allow list: if isSignedIn();
      allow create: if isDoctor(request.resource.data.doctorId);
      allow update, delete: if isDoctor(resource.data.doctorId) || isAdmin();
    }

    /**
     * @description Marketing content, publicly readable, admin writable.
     * @path /supportingOrganizations/{orgId}, /clientCompanies/{companyId}, /blogPosts/{postId}, etc.
     */
    match /{collection}/{docId} 
    where collection in ['supportingOrganizations', 'clientCompanies', 'blogPosts', 'pricingPlans', 'productFeatures', 'teamMembers'] {
        allow get, list: if true;
        allow create, update, delete: if isAdmin() || isSystemAdmin();
    }
  }
}
