/**
 * This ruleset enforces a security model for an e-prescription system, primarily
 * based on user ownership and shared access for collaborative documents like
 * prescriptions. It also introduces an 'admin' role with elevated privileges.
 *
 * Core Philosophy:
 * The security model is designed to be strict and explicit. Data access is
 * granted on a need-to-know basis. A user can only access data directly
 * related to them. Admins are granted broader read access for oversight.
 *
 * Data Structure:
 * The data is organized into flat, top-level collections. Roles are stored on
 * the '/doctors/{userId}' document.
 *
 * Key Security Decisions:
 * 1. Roles: An 'admin' role is introduced. This role has read-only access to most
 *    data collections for administrative and monitoring purposes. This is checked
 *    using the `isAdmin()` function.
 * 2. Patient Data: A strict user-ownership model is applied. Only the patient
 *    or an admin can read the data. Only the patient can write.
 * 3. Prescriptions: A "Shared Access" model is used. Access is granted if the user
 *    is a participant (patient, doctor, pharmacy) or an admin. Writes are restricted
 *    to the doctor.
 * 4. Reference Data: Collections like 'doctors', 'hospitals', and 'pharmacies'
 *    are readable by any authenticated user but not writable by clients, implying
 *    management by an admin process or admins themselves in the future.
 * 5. Denormalization for Authorization: Prescriptions contain denormalized UIDs
 *    to avoid slow and costly `get()` calls in rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    // ===================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document currently exists in Firestore.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Checks for update/delete, ensuring the user is the owner of an existing doc.
     */
    function isOwnerOfExistingDoc(userId) {
      return isOwner(userId) && isExistingDoc();
    }
    
    /**
     * Checks if the user has the 'admin' role by reading their profile.
     * This get() call is a single, efficient check.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/doctors/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * Checks if the user is a participant in a given prescription.
     */
    function isParticipant(prescription) {
      let participantIds = [prescription.patientId, prescription.doctorId, prescription.pharmacyId];
      return isSignedIn() && request.auth.uid in participantIds;
    }
    
     /**
     * Checks if the user is the doctor who created the prescription.
     */
    function isDoctor(doctorId) {
      return isSignedIn() && request.auth.uid == doctorId;
    }

    /**
     * Robust check for update/delete by a doctor.
     */
    function isExistingDoctor(doctorId) {
      return isDoctor(doctorId) && isExistingDoc();
    }


    // Collection Rules
    // =================

    /**
     * @description Manages patient profiles. Read by owner or admin. Write by owner only.
     * @path /patients/{patientId}
     */
    match /patients/{patientId} {
      allow get, list: if isOwner(patientId) || isAdmin();
      allow create: if isOwner(patientId) && request.resource.data.id == patientId;
      allow update: if isOwnerOfExistingDoc(patientId) && request.resource.data.id == resource.data.id;
      allow delete: if isOwnerOfExistingDoc(patientId);
    }

    /**
     * @description Stores doctor/user profiles. Any signed-in user can read.
     * Admins can update any profile (e.g., to assign roles). Users can update their own.
     * @path /doctors/{doctorId}
     */
    match /doctors/{doctorId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(doctorId); // Allow users to create their own profile
      allow update: if isOwner(doctorId) || isAdmin();
      allow delete: if false; // Deletes handled by admin process
    }

    /**
     * @description Stores hospital information. Read-only for clients.
     * @path /hospitals/{hospitalId}
     */
    match /hospitals/{hospitalId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Stores pharmacy information. Read-only for clients.
     * @path /pharmacies/{pharmacyId}
     */
    match /pharmacies/{pharmacyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();

      /**
       * @description Manages a pharmacy's inventory. Only the pharmacy or an admin can manage it.
       * @path /pharmacies/{pharmacyId}/inventory/{inventoryId}
       */
      match /inventory/{inventoryId} {
        allow get, list: if isOwner(pharmacyId) || isAdmin();
        allow create: if isOwner(pharmacyId) && request.resource.data.pharmacyId == pharmacyId;
        allow update: if isOwnerOfExistingDoc(pharmacyId) && request.resource.data.pharmacyId == resource.data.id;
        allow delete: if isOwnerOfExistingDoc(pharmacyId);
      }
    }

    /**
     * @description Stores medication details. Publicly readable. Writable by admin.
     * @path /medications/{medicationId}
     */
    match /medications/{medicationId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Manages prescriptions. Readable by participants or admin. Writable by the doctor.
     * @path /prescriptions/{prescriptionId}
     */
    match /prescriptions/{prescriptionId} {
      allow get: if isParticipant(resource.data) || isAdmin();
      allow list: if isSignedIn();
      allow create: if isDoctor(request.resource.data.doctorId);
      allow update: if isExistingDoctor(resource.data.doctorId) || isAdmin(); // Admin can update status
      allow delete: if isExistingDoctor(resource.data.doctorId) || isAdmin();
    }

    /**
     * @description Stores info about supporting organizations. Publicly readable, admin writable.
     * @path /supportingOrganizations/{orgId}
     */
    match /supportingOrganizations/{orgId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Stores info about client companies. Publicly readable, admin writable.
     * @path /clientCompanies/{companyId}
     */
    match /clientCompanies/{companyId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Stores blog posts. Publicly readable, admin writable.
     * @path /blogPosts/{postId}
     */
    match /blogPosts/{postId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }

    /**
     * @description Stores pricing plans. Publicly readable, admin writable.
     * @path /pricingPlans/{planId}
     */
    match /pricingPlans/{planId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }
  }
}
